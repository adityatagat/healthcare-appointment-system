============================= test session starts ==============================
platform darwin -- Python 3.12.11, pytest-8.2.2, pluggy-1.6.0 -- /Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/bin/python3.12
cachedir: .pytest_cache
rootdir: /Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service
plugins: anyio-4.9.0
collecting ... collected 10 items

app/test_conditions.py::test_crud_lifecycle_condition FAILED             [ 10%]
app/test_conditions.py::test_crud_lifecycle_condition ERROR              [ 10%]
app/test_conditions.py::test_condition_validation_error ERROR            [ 20%]

==================================== ERRORS ====================================
______________ ERROR at teardown of test_crud_lifecycle_condition ______________
app/conftest.py:15: in mongo_clean_and_seed
    asyncio.run(clean_and_seed())  # Clean after test too
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:195: in run
    return runner.run(main)
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
app/conftest.py:9: in clean_and_seed
    await db["observations"].delete_many({})
venv/lib/python3.12/site-packages/motor/metaprogramming.py:75: in method
    return framework.run_on_executor(
venv/lib/python3.12/site-packages/motor/frameworks/asyncio/__init__.py:85: in run_on_executor
    return loop.run_in_executor(_EXECUTOR, functools.partial(fn, *args, **kwargs))
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:854: in run_in_executor
    self._check_closed()
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:545: in _check_closed
    raise RuntimeError('Event loop is closed')
E   RuntimeError: Event loop is closed
---------------------------- Captured stdout setup -----------------------------
Seeded 3 FHIR R4 medical records (Observation).
Seeded 2 FHIR R4 Condition records.
Seeded 2 FHIR R4 Procedure records.
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2025-07-30T18:56:11.fZ", "level": "info", "message": "Creating condition (id: cond1) (MongoDB)", "service": "medical-records-service", "environment": "production"}
------------------------------ Captured log call -------------------------------
INFO     medical-records-service:conditions.py:40 Creating condition (id: cond1) (MongoDB)
______________ ERROR at setup of test_condition_validation_error _______________
app/conftest.py:13: in mongo_clean_and_seed
    asyncio.run(clean_and_seed())
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:195: in run
    return runner.run(main)
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
app/conftest.py:9: in clean_and_seed
    await db["observations"].delete_many({})
venv/lib/python3.12/site-packages/motor/metaprogramming.py:75: in method
    return framework.run_on_executor(
venv/lib/python3.12/site-packages/motor/frameworks/asyncio/__init__.py:85: in run_on_executor
    return loop.run_in_executor(_EXECUTOR, functools.partial(fn, *args, **kwargs))
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:854: in run_in_executor
    self._check_closed()
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:545: in _check_closed
    raise RuntimeError('Event loop is closed')
E   RuntimeError: Event loop is closed
=================================== FAILURES ===================================
________________________ test_crud_lifecycle_condition _________________________
app/test_conditions.py:14: in test_crud_lifecycle_condition
    r = client.post("/api/v1/conditions/", json=condition)
venv/lib/python3.12/site-packages/starlette/testclient.py:633: in post
    return super().post(
venv/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
venv/lib/python3.12/site-packages/starlette/testclient.py:516: in request
    return super().request(
venv/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
venv/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.12/site-packages/starlette/testclient.py:398: in handle_request
    raise exc
venv/lib/python3.12/site-packages/starlette/testclient.py:395: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
venv/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/prometheus_fastapi_instrumentator/middleware.py:174: in __call__
    raise exc
venv/lib/python3.12/site-packages/prometheus_fastapi_instrumentator/middleware.py:172: in __call__
    await self.app(scope, receive, send_wrapper)
venv/lib/python3.12/site-packages/opentelemetry/instrumentation/asgi/__init__.py:631: in __call__
    await self.app(scope, otel_receive, otel_send)
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:65: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.12/site-packages/starlette/routing.py:756: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:776: in app
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:77: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
venv/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.12/site-packages/starlette/routing.py:72: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:278: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/routers/conditions.py:46: in create_condition
    exists = await COLLECTION.find_one({"id": validated.id})
venv/lib/python3.12/site-packages/motor/metaprogramming.py:75: in method
    return framework.run_on_executor(
venv/lib/python3.12/site-packages/motor/frameworks/asyncio/__init__.py:85: in run_on_executor
    return loop.run_in_executor(_EXECUTOR, functools.partial(fn, *args, **kwargs))
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:854: in run_in_executor
    self._check_closed()
/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py:545: in _check_closed
    raise RuntimeError('Event loop is closed')
E   RuntimeError: Event loop is closed
---------------------------- Captured stdout setup -----------------------------
Seeded 3 FHIR R4 medical records (Observation).
Seeded 2 FHIR R4 Condition records.
Seeded 2 FHIR R4 Procedure records.
----------------------------- Captured stdout call -----------------------------
{"timestamp": "2025-07-30T18:56:11.fZ", "level": "info", "message": "Creating condition (id: cond1) (MongoDB)", "service": "medical-records-service", "environment": "production"}
------------------------------ Captured log call -------------------------------
INFO     medical-records-service:conditions.py:40 Creating condition (id: cond1) (MongoDB)
=========================== short test summary info ============================
FAILED app/test_conditions.py::test_crud_lifecycle_condition - RuntimeError: ...
ERROR app/test_conditions.py::test_crud_lifecycle_condition - RuntimeError: E...
ERROR app/test_conditions.py::test_condition_validation_error - RuntimeError:...
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 3 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
=================== 1 failed, 4 warnings, 2 errors in 0.69s ====================
--- Logging error ---
Traceback (most recent call last):
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/connection.py", line 198, in _new_conn
    sock = connection.create_connection(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/util/connection.py", line 85, in create_connection
    raise err
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/util/connection.py", line 73, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/connectionpool.py", line 787, in urlopen
    response = self._make_request(
               ^^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/connectionpool.py", line 493, in _make_request
    conn.request(
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/connection.py", line 494, in request
    self.endheaders()
  File "/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py", line 1333, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File "/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py", line 1093, in _send_output
    self.send(msg)
  File "/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/http/client.py", line 1037, in send
    self.connect()
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/connection.py", line 325, in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/connection.py", line 213, in _new_conn
    raise NewConnectionError(
urllib3.exceptions.NewConnectionError: <urllib3.connection.HTTPConnection object at 0x1024b0410>: Failed to establish a new connection: [Errno 61] Connection refused

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/requests/adapters.py", line 667, in send
    resp = conn.urlopen(
           ^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/connectionpool.py", line 841, in urlopen
    retries = retries.increment(
              ^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/urllib3/util/retry.py", line 519, in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='localhost', port=4318): Max retries exceeded with url: /v1/traces (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x1024b0410>: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/opentelemetry/sdk/trace/export/__init__.py", line 367, in _export_batch
    self.span_exporter.export(self.spans_list[:idx])  # type: ignore
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/opentelemetry/exporter/otlp/proto/http/trace_exporter/__init__.py", line 145, in export
    resp = self._export(serialized_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/opentelemetry/exporter/otlp/proto/http/trace_exporter/__init__.py", line 114, in _export
    return self._session.post(
           ^^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/requests/sessions.py", line 637, in post
    return self.request("POST", url, data=data, json=json, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/requests/sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/requests/sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/requests/adapters.py", line 700, in send
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='localhost', port=4318): Max retries exceeded with url: /v1/traces (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x1024b0410>: Failed to establish a new connection: [Errno 61] Connection refused'))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/logging/__init__.py", line 1163, in emit
    stream.write(msg + self.terminator)
ValueError: I/O operation on closed file.
Call stack:
  File "/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/threading.py", line 1032, in _bootstrap
    self._bootstrap_inner()
  File "/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/threading.py", line 1075, in _bootstrap_inner
    self.run()
  File "/opt/homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/threading.py", line 1012, in run
    self._target(*self._args, **self._kwargs)
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/opentelemetry/sdk/trace/export/__init__.py", line 291, in worker
    self._drain_queue()
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/opentelemetry/sdk/trace/export/__init__.py", line 384, in _drain_queue
    self._export_batch()
  File "/Users/adityatagat/CascadeProjects/healthcare-appointment-system/services/medical-records-service/venv/lib/python3.12/site-packages/opentelemetry/sdk/trace/export/__init__.py", line 369, in _export_batch
    logger.exception("Exception while exporting Span batch.")
Message: 'Exception while exporting Span batch.'
Arguments: ()
